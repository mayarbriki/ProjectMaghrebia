<app-header-front></app-header-front>
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-6">
    {{ isEditMode ? 'Edit' : 'Add New' }} Property
  </h1>

  <!-- Top-level FormGroup is defined here -->
  <form [formGroup]="propertyForm" (ngSubmit)="submitForm()" class="space-y-6">
    
    <!-- Shared Fields -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Basic Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Property Type -->
        <div class="form-group">
          <label for="type" class="block mb-2 font-medium">Property Type *</label>
          <select
            id="type"
            formControlName="type"
            class="w-full p-2 border rounded-md"
            [class.border-red-500]="propertyForm.get('type')?.invalid && propertyForm.get('type')?.touched">
            <option [ngValue]="null" disabled>Select a property type</option>
            <option *ngFor="let type of propertyTypes" [value]="type">
              {{ type | titlecase }}
            </option>
          </select>
          <div
            *ngIf="propertyForm.get('type')?.invalid && propertyForm.get('type')?.touched"
            class="text-red-500 mt-1">
            Property type is required
          </div>
        </div>

        <!-- Estimated Value -->
        <div class="form-group">
          <label for="estimatedValue" class="block mb-2 font-medium">Estimated Value</label>
          <input
            type="number"
            id="estimatedValue"
            formControlName="estimatedValue"
            class="w-full p-2 border rounded-md">
        </div>

        <!-- Name -->
        <div class="form-group md:col-span-2">
          <label for="name" class="block mb-2 font-medium">Name *</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            class="w-full p-2 border rounded-md"
            [class.border-red-500]="propertyForm.get('name')?.invalid && propertyForm.get('name')?.touched">
          <div
            *ngIf="propertyForm.get('name')?.invalid && propertyForm.get('name')?.touched"
            class="text-red-500 mt-1">
            Name is required
          </div>
        </div>

        <!-- Description -->
        <div class="form-group md:col-span-2">
          <label for="description" class="block mb-2 font-medium">Description *</label>
          <textarea
            id="description"
            formControlName="description"
            rows="4"
            class="w-full p-2 border rounded-md"
            [class.border-red-500]="propertyForm.get('description')?.invalid && propertyForm.get('description')?.touched">
          </textarea>
          <div
            *ngIf="propertyForm.get('description')?.invalid && propertyForm.get('description')?.touched"
            class="text-red-500 mt-1">
            Description is required
          </div>
        </div>
      </div>
    </div>

    <!-- Child Component Forms -->
    <app-car-property-form *ngIf="propertyForm.get('type')?.value === 'CAR'"></app-car-property-form>
    <app-commercial-property-form *ngIf="propertyForm.get('type')?.value === 'COMMERCIAL'"></app-commercial-property-form>
    <app-residence-property-form *ngIf="propertyForm.get('type')?.value === 'RESIDENCE'"></app-residence-property-form>
    <app-life-property-form *ngIf="propertyForm.get('type')?.value === 'LIFE'"></app-life-property-form>
    <app-travel-property-form *ngIf="propertyForm.get('type')?.value === 'TRAVEL'"></app-travel-property-form>


<!-- Location Map for Residence or Commercial Properties -->
<div *ngIf="propertyForm.get('type')?.value === 'RESIDENCE' || propertyForm.get('type')?.value === 'COMMERCIAL'" class="bg-white rounded-lg shadow p-6">
  <h2 class="text-xl font-semibold mb-4">Location</h2>
  
  <!-- Map Controls -->
  <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="form-group">
      <label for="latitude" class="block mb-2 font-medium">Latitude *</label>
      <input
        type="number"
        id="latitude"
        formControlName="latitude"
        class="w-full p-2 border rounded-md"
        [class.border-red-500]="propertyForm.get('latitude')?.invalid && propertyForm.get('latitude')?.touched"
        (change)="updateMarkerPosition()">
      <div *ngIf="propertyForm.get('latitude')?.invalid && propertyForm.get('latitude')?.touched" class="text-red-500 mt-1">
        Latitude is required
      </div>
    </div>
    <div class="form-group">
      <label for="longitude" class="block mb-2 font-medium">Longitude *</label>
      <input
        type="number"
        id="longitude"
        formControlName="longitude"
        class="w-full p-2 border rounded-md"
        [class.border-red-500]="propertyForm.get('longitude')?.invalid && propertyForm.get('longitude')?.touched"
        (change)="updateMarkerPosition()">
      <div *ngIf="propertyForm.get('longitude')?.invalid && propertyForm.get('longitude')?.touched" class="text-red-500 mt-1">
        Longitude is required
      </div>
    </div>
  </div>
  
  <!-- Current Position Button -->
  <div class="mb-4">
    <button (click)="getCurrentPosition()" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 2a8 8 0 018 8 8 8 0 01-8 8 8 8 0 01-8-8 8 8 0 018-8zm1 12h-2v-2H7v-2h2V8h2v2h2v2h-2v2z" />
      </svg>
      Get Current Position
    </button>
  </div>
  
  <!-- Map container -->
  <div class="map-container" style="height: 400px; border: 1px solid #ccc; border-radius: 4px; position: relative; overflow: hidden;" 
    leaflet 
    [leafletOptions]="options" 
    (leafletMapReady)="onMapReady($event)">
  </div>
  
  <div class="mt-2 text-sm text-gray-600">
    Click on the map to set the location, or drag the marker to the desired position.
  </div>
</div>


    <!-- Images Section -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Images</h2>
      
      <!-- Existing Images -->
      <div *ngIf="existingImages.length > 0" class="mb-6">
        <h3 class="text-lg font-medium mb-3">Existing Images</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <div *ngFor="let image of existingImages" class="relative">
            <img
              [src]="getImageUrl(image.id)"
              alt="Property image"
              class="w-full h-32 object-cover rounded">
            <button
              type="button"
              class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1"
              (click)="markImageForDeletion(image.id)">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 
                      4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 
                      01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Upload New Images -->
      <div>
        <h3 class="text-lg font-medium mb-3">Upload New Images</h3>
        <input
          type="file"
          multiple
          (change)="onFileSelect($event)"
          class="p-2 border rounded w-full">
      </div>
      
      <!-- Selected Files Preview -->
      <div *ngIf="selectedFiles.length > 0" class="mt-4">
        <h3 class="text-lg font-medium mb-3">Selected Files</h3>
        <ul class="space-y-2">
          <li
            *ngFor="let file of selectedFiles; let i = index"
            class="flex justify-between items-center p-2 bg-gray-50 rounded">
            <span>{{ file.name }} ({{ (file.size / 1024).toFixed(2) }} KB)</span>
            <button
              type="button"
              class="text-red-500"
              (click)="removeSelectedFile(i)">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 
                      1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 
                      01-1.414 1.414L10 11.414l-4.293 
                      4.293a1 1 0 
                      01-1.414-1.414L8.586 10 4.293 
                      5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd" />
              </svg>
            </button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Form Buttons -->
    <div class="flex justify-end space-x-4">
      <button type="button" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400 transition-colors" (click)="cancel()">
        Cancel
      </button>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
        {{ isEditMode ? 'Update' : 'Save' }} Property
      </button>
    </div>
  </form>

  <app-property-list></app-property-list>
</div>